#!/usr/bin/env python3
"""Listen for monitor hotplug events via udev and run a script."""

import argparse
import logging
import subprocess

import pyudev

logging.basicConfig(
    format="%(asctime)s [%(levelname)s] %(message)s",
    datefmt="%H:%M:%S",
    level=logging.INFO,
)
log = logging.getLogger(__name__)

UDEV_SUBSYSTEM = "drm"
HOTPLUG_ACTIONS = frozenset({"change", "add", "remove"})


def listen(script: str) -> None:
    context = pyudev.Context()
    monitor = pyudev.Monitor.from_netlink(context)
    monitor.filter_by(subsystem=UDEV_SUBSYSTEM)

    log.info("Listening for monitor hotplug events (running '%s' on change)â€¦", script)

    for device in iter(monitor.poll, None):
        if device.action in HOTPLUG_ACTIONS:
            log.info("[%s] %s", device.action, device.device_path)
            result = subprocess.run([script], check=False)
            if result.returncode != 0:
                log.warning("'%s' exited with code %d", script, result.returncode)


def main() -> None:
    parser = argparse.ArgumentParser(description="Run a script on monitor hotplug events.")
    parser.add_argument("script", help="Script to run (must be in PATH or an absolute path)")
    args = parser.parse_args()
    listen(args.script)


if __name__ == "__main__":
    main()
